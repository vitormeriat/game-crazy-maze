<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style type="text/css">
        /* O pequeno bloco de CSS permite forçar a página a ser 100 por cento da altura da janela, e overflow: hidden impede das barras de rolagem 
            vertical e horizontal aparecer, se exceder a área visível na tela. */
        html {
            height: 100%;
            /*overflow: hidden;*/
        }

        body {
            margin: 0px;
            padding: 0px;
            height: 100%;
        }

        .tudo {
            border-style: solid;
            border-width: 10px;
            background-color: #008B00;
            background-image: url(background.png);
            margin: -270px 0 0 0px;
            position: absolute;
            top: 50%;
        }
    </style>
</head>
<body>
    <canvas id="tela" width="1440"; height="540"; class="tudo">Sem suporte ao HTML5</canvas>

    <script type="text/javascript">

        var canvas = document.getElementById("tela");

        // Força o Canvas alterar dinamicamente seu tamanho para
        // a mesma largura / altura conforme a janela do navegador
        //canvas.width = document.body.clientWidth;
        //canvas.height = document.body.clientHeight;

        var ctx = canvas.getContext("2d");

        // Hero imagem        
        var heroImage = new Image();
        heroImage.src = "hero.png";
        // Porta              
        var portaImage = new Image();
        portaImage.src = "porta.png";
        // Bloco
        var blocoImage = new Image();
        blocoImage.src = "bloco.png";
        // Monstro
        var monsterImage = new Image();
        monsterImage.src = "monster.png";


        var stageQTX = 40; // Largura
        var stageQTY = 15; // Altura
        var stageW = 36; // Largura de um quadrante
        var stageH = 36; // Altura de um quadrante

        // Define o grid
        /* Comportamentos:
            1 = Sem bloco;
            0 = Com bloco;
            3 = Saída;
            4 = Bloco invisível
        */
        var stageLevel = new Array();
        stageLevel.push(new Array(4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4));
        stageLevel.push(new Array(4, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 6, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 5, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4));
        stageLevel.push(new Array(4, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 4));
        stageLevel.push(new Array(4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4));


        var blocks = new Array();

        function Block() {
            this.gridX = 0;
            this.gridY = 0;
            this.X = 0;
            this.Y = 0;
            this.type = 0;
        }
        // Cria um objeto Player
        function Player() {
            this.gridX = 0;
            this.gridY = 0;
        }
        // Inicia o Player na posição
        var player = new Player();
        player.gridX = 1;
        player.gridY = 1;

        // Verifica se a posição solicitada é grid(paredes do labirinto).         
        function isGrid(gridX, gridY) {
            // Limita a área do grid para o player não sair do tabuleiro.
            if (gridX < 0 || gridX > stageLevel[0].length - 1 ||
                gridY < 0 || gridY > stageLevel.length - 1) {
                return true;
            }

            // Caso o type seja 4 (Cenário) desabilito o player a continuar o movimento.
            if (stageLevel[gridY][gridX] == 4) {
                return true;
            }

            // Caso o type seja 5 (monstro) habilito que o player possa continuar o movimento.
            // Isso ocorre para que o player possa se chocar com o monstro o que vai ocasionar em derrota.
            if (stageLevel[gridY][gridX] == 5) {
                return false;
            }

            for (var i = 0; i < blocks.length ; i++) {
                if (blocks[i].gridX == gridX && blocks[i].gridY ==
                    gridY && blocks[i].type != 3) {
                    return true;
                }
            }

            return false;
        }

        // Verifica se a posição solicitada é a saída.
        function isOut(gridX, gridY) {
            for (var i = 0; i < blocks.length ; i++) {
                if (blocks[i].gridX == gridX && blocks[i].gridY ==
                    gridY && blocks[i].type == 3) {
                    return true;
                }
            }
            return false;
        }
        // Verifica se a posição solicitada leva há um monstro.
        function isMonster(gridX, gridY) {
            for (var i = 0; i < blocks.length ; i++) {
                if (blocks[i].gridX == gridX && blocks[i].gridY == gridY
                    && blocks[i].type == 5) {
                    //alert(blocks[i].type);
                    return true;
                }
            }
            return false;
        }

        // Verifica se o movimento que está sendo solicitado é um movimento válido
        function tryMove(gridX, gridY) {
            if (!isGrid(gridX, gridY)) {
                // Atribui a posição ao player
                player.gridX = parseInt(gridX);
                player.gridY = parseInt(gridY);
                // Atualiza o grid com a nova posição do player
                atualizarGrid();

                if (monsterIsNear(gridX, gridY)) {
                    alert("Monstro a vista!");
                }

                // Caso o movimento seja a saída...
                if (isOut(gridX, gridY)) {
                    gameWins();
                }
                // Caso tenha topado com o monstro...
                if (isMonster(gridX, gridY)) {
                    gameOver();
                }
            }
        }

        function monsterIsNear(gridX, gridY) {
            //[15][16][ 4][ 7][ 6]
            //[14][ #][ #][ #][ 5]
            //[ 2][ #][ X][ #][ 1]
            //[13][ #][ #][ #][ 8]
            //[12][11][ 3][10][ 9]

            // Caso o type seja 4 (Cenário) desabilito o player a continuar o movimento.
            if (stageLevel[gridY][gridX] == 5) {
                return true;// É monstro
            }
            else if (stageLevel[gridY][gridX + 2] == 5) {
                return true;// Verifica se o segundo quadrante da direita é monstro [1]
            }
            else if (stageLevel[gridY][gridX - 2] == 5) {
                return true;// Verifica se o segundo quadrante da esquerda é monstro [2]
            }
            else if (stageLevel[gridY + 2][gridX] == 5) {
                return true;// Verifica se o segundo quadrante para baixo é monstro [3]
            }
            else if (stageLevel[gridY - 2][gridX] == 5) {
                return true;// Verifica se o segundo quadrante para cima é monstro [4]
            }
            else if (stageLevel[gridY - 1][gridX + 2] == 5) {
                return true;// [5]
            }
            else if (stageLevel[gridY - 2][gridX + 2] == 5) {
                return true;// [6]
            }
            else if (stageLevel[gridY - 2][gridX + 1] == 5) {
                return true;// [7]
            }
            else if (stageLevel[gridY + 1][gridX + 2] == 5) {
                return true;// [8]
            }
            else if (stageLevel[gridY + 2][gridX + 2] == 5) {
                return true;// [9]
            }
            else if (stageLevel[gridY + 2][gridX + 1] == 5) {
                return true;// [10]
            }
            else if (stageLevel[gridY + 2][gridX - 1] == 5) {
                return true;// [11]
            }
            else if (stageLevel[gridY + 2][gridX - 2] == 5) {
                return true;// [12]
            }
            else if (stageLevel[gridY + 1][gridX - 2] == 5) {
                return true;// [13]
            }
            else if (stageLevel[gridY - 1][gridX - 2] == 5) {
                return true;// [14]
            }
            else if (stageLevel[gridY - 2][gridX - 2] == 5) {
                return true;// [15]
            }
            else if (stageLevel[gridY - 2][gridX - 1] == 5) {
                return true;// [16]
            }
        }
        function moveMonster() {
        }

        function gameWins() {
            ctx.fillStyle = '#228B22';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            var phrase = "Parabéns, você achou a saída! Clique ou toque na tela para iniciar o jogo";
            ctx.font = 'bold 16px Arial, sans-serif';
            var mt = ctx.measureText(phrase);
            var xcoord = (canvas.width / 2) - (mt.width / 2);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText(phrase, xcoord, 30);
        }

        function gameOver() {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            var phrase = "Você perdeu! Clique ou toque na tela para iniciar o jogo";
            ctx.font = 'bold 16px Arial, sans-serif';
            var mt = ctx.measureText(phrase);
            var xcoord = (canvas.width / 2) - (mt.width / 2);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText(phrase, xcoord, 30);
        }

        // Monta o cenário do jogo.
        // Percorre o array com as configurações do level
        for (var a = 0; stageLevel.length > a; a++) {
            for (var i = 0; stageLevel[a].length > i; i++) {
                // Verifica os tipos com imagens
                if (stageLevel[a][i] == 0 || stageLevel[a][i] == 3 || stageLevel[a][i] == 5) {
                    //if (stageLevel[a][i] == 3 || Math.random() > 0.5) {
                    var temp = new Block();
                    temp.gridX = i;
                    temp.gridY = a;
                    temp.type = stageLevel[a][i];

                    blocks.push(temp);
                }
            }
        }

        function desenharGrid(gridX, gridY) {
            //ctx.drawImage(blocoImage, gridX * stageW, gridY * stageH);
            ctx.drawImage(blocoImage, gridX * stageW, gridY * stageH);
            //Definindo a cor do grid: LemonChiffon3 / 205 201 165 / #CDC9A5
            //ctx.fillStyle = "rgb(205,201,165)";
            //desenha os quadrados
            //ctx.fillRect(gridX * stageW, gridY * stageH, stageW, stageH);
        }

        function desenharSaida(gridX, gridY) {
            ctx.drawImage(portaImage, gridX * stageW, gridY * stageH);
            //Definindo a cor azul
            //ctx.fillStyle = "rgb(139,136,120)";
            //desenha o quadrado azul
            //ctx.fillRect(gridX * stageW, gridY * stageH, stageW, stageH);
        }

        function desenharMonster(gridX, gridY) {
            ctx.drawImage(monsterImage, gridX * stageW, gridY * stageH);
        }

        function desenharPlayer(gridX, gridY) {
            ctx.drawImage(heroImage, gridX * stageW, gridY * stageH);
            //Definindo a cor azul
            //ctx.fillStyle = "rgb(0,255,255)";
            //desenha o quadrado azul
            //ctx.fillRect(gridX * stageW, gridY * stageH, stageW, stageH);
        }

        // Atualiza o Grid desenhando a cena
        function atualizarGrid() {
            //limpa todo o Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Percorre o array e verifica o type do block
            for (var a = 0; blocks.length > a; a++) {
                // Caso seja saída...
                if (blocks[a].type == 3) {
                    desenharSaida(blocks[a].gridX, blocks[a].gridY);
                }
                else if (blocks[a].type == 5) {
                    desenharMonster(blocks[a].gridX, blocks[a].gridY);
                }
                else {
                    // senão desenha os blocos
                    desenharGrid(blocks[a].gridX, blocks[a].gridY);
                }
            }
            desenharPlayer(player.gridX, player.gridY);
        }

        window.onkeydown = pressionaTecla;

        function pressionaTecla(e) {
            playerX = parseInt(player.gridX);
            playerY = parseInt(player.gridY);

            //http://www.cambiaresearch.com/articles/15/javascript-char-codes-key-codes
            if (e.keyCode == 37) {
                tryMove(playerX - 1, playerY); //move para esquerda
            }
            else if (e.keyCode == 39) {
                tryMove(playerX + 1, playerY); //move para direita
            }
            else if (e.keyCode == 38) {
                tryMove(playerX, playerY - 1); //move para cima
            }
            else if (e.keyCode == 40) {
                tryMove(playerX, playerY + 1); //move para baixo
            }
            //else if (e.keyCode == 8) {
            //    tryMove(playerX, playerY + 1); //backspace
            //}
        }

        atualizarGrid();
    </script>

</body>
</html>
